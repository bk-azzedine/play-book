<div class="flex flex-col p-5 space-y-6">
  <div>
    <span class="text-black text-xl font-bold">Spaces</span>
  </div>
  <hlm-toaster/>
  <div class="flex flex-col space-y-8">

    <div>
      <div class="flex flex-row justify-between items-center">
        <span class="text-black text-lg font-bold">Spaces you're in</span>
        <div class="flex flex-row space-x-4">
          <button
            hlmBtn
            brnDialogTrigger
            [brnDialogTriggerFor]="dialog"
            class="w-24 h-8 hover:bg-accent hover:text-accent-foreground flex flex-row space-x-2"
            style="animation-delay: 300ms;"
            (click)="$event.stopPropagation()">
            <ng-icon name="lucidePlus" size="17" strokeWidth="4"></ng-icon>
            <span class="text-bg-primary font-medium relative bottom-0.5">Create</span>
          </button>
        </div>
      </div>
    </div>

    <!-- User Spaces Carousel -->
    <div class="mb-8">
      <div class="flex w-full items-center justify-start p-4 pb-0">
        <div class="w-full">
          <app-carousel
            [itemsPerView]="4"
            [gap]="70"
            [showDots]="false"
            [responsive]="{
              '640': 1,
              '768': 2,
              '1024': 3,
              '1280': 4
            }"
            (slideChange)="onSlideChange($event)"
          >
            <app-carousel-item *ngFor="let space of userSpaces; trackBy: trackBySpaceId">
              <app-space-card [spaceSignal]="space" (click)="view(space.spaceId)"></app-space-card>
            </app-carousel-item>
          </app-carousel>
        </div>
      </div>
    </div>

    <div>
      <div class="flex flex-row justify-between items-center">
        <span class="text-black text-lg font-bold">Spaces within your team</span>
      </div>
    </div>

    <!-- Team Spaces Carousel -->
    <div class="mb-8">
      <div class="flex w-full items-center justify-start p-4 pb-0">
        <div class="w-full">
          <app-carousel
            [itemsPerView]="4"
            [gap]="70"
            [showDots]="false"
            [responsive]="{
              '640': 1,
              '768': 2,
              '1024': 3,
              '1280': 4
            }"
            (slideChange)="onTeamSlideChange($event)"
          >
            <app-carousel-item *ngFor="let space of teamSpaces; trackBy: trackBySpaceId">
              <app-space-card [spaceSignal]="space" (click)="view(space.spaceId)"></app-space-card>
            </app-carousel-item>
          </app-carousel>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Keep your existing dialog unchanged -->
<brn-dialog #dialog>
  <form
    class="w-full flex flex-col items-center justify-center max-w-md mx-auto space-y-6"
    [formGroup]="spaceForm"
    (ngSubmit)="saveSpace()"
  >
    <hlm-dialog-content *brnDialogContent="let ctx"
                        class="sm:max-w-xl w-full bg-[#F1F0FC] border-none shadow-lg max-h-[75vh] flex flex-col">
      <ng-scrollbar class="w-full h-full border-none flex-grow">
        <div class="bg-[#F1F0FC] p-3 rounded-t-lg">
          <h3 class="text-xl font-bold text-black mb-4">Create a new space for your team</h3>

          <div class="mb-5">
            <label class="block text-sm font-medium text-black mb-2">Space Name</label>
            <input
              hlmInput
              id="name"
              placeholder="Enter space name"
              formControlName="name"
              class="w-full bg-background border border-indigo-200 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
            />
            <hlm-error *ngIf="spaceForm.get('name')?.hasError('maxlength')">the max length for the name is 20
              characters
            </hlm-error>

          </div>

          <div class="mb-5">
            <label class="block text-sm font-medium text-black mb-2">Space Icon</label>
            <div
              class="flex flex-wrap gap-3 max-h-36 overflow-y-auto p-3 bg-background rounded-md border border-indigo-200">
              <button
                type="button"
                *ngFor="let icon of icons; let i = index"
                class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-indigo-100 transition-all"
                [class.ring-2]="selectedIconIndex === i"
                [class.ring-indigo-500]="selectedIconIndex === i"
                (click)="selectIcon(i)">
                <ng-icon [name]="icon" size="20" [color]="selectedIconIndex === i ? '#4f46e5' : '#6366f1'"></ng-icon>
              </button>
            </div>
          </div>

          <div class="mb-5">
            <label class="block text-sm font-medium text-black mb-2">Description</label>
            <textarea
              hlmInput
              id="description"
              formControlName="description"
              placeholder="What's this space about?"
              class="w-full h-24 bg-background border border-indigo-200 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 resize-none"
            ></textarea>
            <hlm-error *ngIf="spaceForm.get('description')?.hasError('maxlength')">the max length for the description is
              200 characters
            </hlm-error>
          </div>

          <div class="mb-5">
            <hlm-form-field class="flex flex-col space-y-2 w-full">
              <label hlmLabel class="text-sm font-medium text-black">Team</label>
              <brn-select formControlName="team">
                <hlm-select-trigger class="w-full bg-background">
                  <hlm-select-value placeholder="Select a team"/>
                </hlm-select-trigger>
                <hlm-select-content class="bg-background shadow-md border-none hover:bg-indigo-50">
                  <ng-container *ngIf="managedTeams.length > 0">
                    <hlm-option *ngFor="let team of managedTeams" [value]="team.teamId">
                      <div class="flex items-center gap-2">
                        <ng-icon name="heroUserGroup" size="16"></ng-icon>
                        <span>{{ team.name }}</span>
                      </div>
                    </hlm-option>
                  </ng-container>

                  <hlm-option *ngIf="managedTeams.length === 0" [value]="null" disabled class="text-gray-400">
                    <div class="flex items-center gap-2">
                      <ng-icon name="heroUserGroup" size="16"></ng-icon>
                      <span>No teams available</span>
                    </div>
                  </hlm-option>
                </hlm-select-content>
              </brn-select>
            </hlm-form-field>
          </div>

          <div class="mb-5">
            <label class="block text-sm font-medium text-black mb-2">Members</label>
            <div class="flex gap-2 items-start relative">
              <hlm-form-field class="w-full">
                <input
                  hlmInput
                  placeholder="Search team members by email or name"
                  [(ngModel)]="memberSearchInput"
                  [ngModelOptions]="{standalone: true}"
                  (input)="onMemberSearchInput()"
                  class="w-full bg-background "
                />
                <div *ngIf="memberSearchInput && filteredUsers.length > 0"
                     class="absolute z-10 mt-1 w-full bg-background border border-indigo-200 rounded-md shadow-lg max-h-40 overflow-y-auto">
                  <ul>
                    <li *ngFor="let user of filteredUsers"
                        class="px-4 py-2 cursor-pointer hover:bg-indigo-100"
                        (click)="selectUser(user)"> {{ formatUserDisplay(user) }}
                    </li>
                  </ul>
                </div>
              </hlm-form-field>

              <hlm-form-field>
                <brn-select [formControl]="privilegeToAssignControl">
                  <hlm-select-trigger class="absolute flex justify-center right-2 top-0.5 h-8  bg-background z-20 ">
                    <hlm-select-value placeholder="Privilege"/>
                  </hlm-select-trigger>
                  <hlm-select-content class="bg-background shadow-md border-none">
                    <hlm-option *ngFor="let privilege of privilegeOptions" [value]="privilege">
                      {{ privilege }}
                    </hlm-option>
                  </hlm-select-content>
                </brn-select>
              </hlm-form-field>

            </div>

            <div *ngIf="selectedMembers.length > 0" class="flex flex-wrap gap-2 mt-3">
                <span *ngFor="let item of selectedMembers; let i = index"
                      class="inline-flex items-center bg-slate-200 text-slate-700 text-xs font-semibold py-1 px-2.5 rounded-full cursor-pointer whitespace-nowrap">
                  {{ formatMemberWithPrivilegeDisplay(item) }}
                  <button (click)="removeMember(i)" type="button"
                          class="ml-1.5 -mr-0.5 text-slate-400 hover:text-slate-600 focus:outline-none flex items-center justify-center h-4 w-4 rounded-full"
                          attr.aria-label="Remove member {{formatMemberWithPrivilegeDisplay(item)}}">
                    <ng-icon name="lucideX" size="12"></ng-icon>
                  </button>
                </span>
            </div>
            <div *ngIf="selectedMembers.length === 0 && spaceForm.get('team')?.value"
                 class="text-gray-500 text-sm mt-2">
              Search and select members from the team above, then choose their privilege.
            </div>
            <div *ngIf="selectedMembers.length === 0 && !spaceForm.get('team')?.value"
                 class="text-gray-500 text-sm mt-2">
              Select a team first to add members.
            </div>
          </div>

          <div class="mb-5">
            <label class="block text-sm font-medium text-black mb-2">Visibility</label>
            <hlm-radio-group
              class="flex flex-row space-x-4"
              formControlName="visibility"
            >
              <label class="flex items-center gap-2 cursor-pointer" hlmLabel>
                <hlm-radio [value]="SpaceVisibilityEnum.PUBLIC">
                  <hlm-radio-indicator indicator></hlm-radio-indicator>
                </hlm-radio>
                <div class="flex items-center gap-1">
                  <ng-icon name="heroGlobeAlt" size="16" class="text-indigo-600"></ng-icon>
                  <span>Public</span>
                </div>
              </label>
              <label class="flex items-center gap-2 cursor-pointer" hlmLabel>
                <hlm-radio [value]="SpaceVisibilityEnum.PRIVATE">
                  <hlm-radio-indicator indicator></hlm-radio-indicator>
                </hlm-radio>
                <div class="flex items-center gap-1">
                  <ng-icon name="heroLockClosed" size="16" class="text-indigo-600"></ng-icon>
                  <span>Private</span>
                </div>
              </label>
            </hlm-radio-group>
          </div>
        </div>
      </ng-scrollbar>

      <div class="flex justify-end gap-3 mt-auto p-6">
        <button
          type="button"
          hlmBtn
          variant="outline"
          class="border-indigo-200 text-indigo-600 hover:bg-indigo-50"
          (click)="ctx.close()">
          Cancel
        </button>
        <button
          type="submit"
          hlmBtn
          (click)="saveSpace()"
          class="bg-indigo-600 hover:bg-indigo-700 text-white flex items-center gap-1"
        >
          <ng-icon name="heroPlus" size="16" color="white"></ng-icon>
          Create Space
        </button>
      </div>
    </hlm-dialog-content>
  </form>
</brn-dialog>
